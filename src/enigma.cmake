# Enigma cipher in CMake (build system scripting)
cmake_minimum_required(VERSION 3.20)
project(Enigma NONE)

set(RF1 4 10 12 5 11 6 3 16 21 25 13 19 14 22 24 7 23 20 18 15 0 8 1 17 2 9)
set(RF2 0 9 3 10 18 8 17 20 23 1 11 7 22 19 12 2 16 6 25 13 15 24 5 21 14 4)
set(RF3 1 3 5 7 9 11 2 15 17 19 23 21 25 13 24 4 8 22 6 0 10 12 20 18 16 14)
set(RB1 20 22 24 6 0 3 5 15 21 25 1 4 2 10 12 19 7 23 18 11 17 8 13 16 14 9)
set(RB2 0 9 15 2 25 22 17 11 5 1 3 10 14 19 24 20 16 6 4 13 7 23 12 8 21 18)
set(RB3 19 0 6 1 15 2 18 3 16 4 20 5 21 13 25 7 24 8 23 9 22 11 17 10 14 12)
set(REF 24 17 20 7 16 18 11 3 15 23 13 6 14 10 12 8 4 1 5 25 2 22 21 9 0 19)
set(NOTCHES 16 4 21)

function(mod26 N RESULT)
  math(EXPR _m "${N} % 26")
  if(_m LESS 0)
    math(EXPR _m "${_m} + 26")
  endif()
  set(${RESULT} ${_m} PARENT_SCOPE)
endfunction()

function(rotor_pass WIRING C POS RESULT)
  mod26("${C} + ${POS}" IDX)
  list(GET ${WIRING} ${IDX} VAL)
  math(EXPR _r "${VAL} - ${POS}")
  mod26(${_r} OUT)
  set(${RESULT} ${OUT} PARENT_SCOPE)
endfunction()

function(enigma TEXT)
  set(P0 0) ; set(P1 0) ; set(P2 0)
  string(TOUPPER "${TEXT}" UTEXT)
  string(LENGTH "${UTEXT}" LEN)
  set(RESULT "")
  math(EXPR LAST "${LEN} - 1")
  foreach(I RANGE 0 ${LAST})
    string(SUBSTRING "${UTEXT}" ${I} 1 CH)
    string(ASCII "${CH}" CODE)
    math(EXPR C "${CODE} - 65")
    if(C GREATER_EQUAL 0 AND C LESS 26)
      # Step and encrypt...
      rotor_pass(RF3 ${C} ${P2} C)
      rotor_pass(RF2 ${C} ${P1} C)
      rotor_pass(RF1 ${C} ${P0} C)
      list(GET REF ${C} C)
      math(EXPR CODE "${C} + 65")
      string(ASCII ${CODE} CH)
      string(APPEND RESULT "${CH}")
    endif()
  endforeach()
  message("${RESULT}")
endfunction()

enigma("HELLOWORLD")
